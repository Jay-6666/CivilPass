# scoring_criteria.py

from typing import Dict

SCORING_RULES = {
    "概括题": {
        "问法关键词": ["概括","总结","简要说明","归纳","提炼","提取","梳理","关键要素","核心信息","主要特征","差异比较","数据整合"],
        "评分维度": {
            "内容要点": {
                "信息覆盖": {
                    "说明": "是否覆盖材料中所有应概括的核心要素",
                    "扣分规则": "遗漏主要要点扣3分；遗漏次要要点扣1分；信息出现明显错误扣2分",
                    "建议": "先通读全文，用划线标注法标记关键信息，确保不遗漏"
                },
                "要点准确": {
                    "说明": "概括是否与原意一致，未歪曲材料含义",
                    "扣分规则": "严重曲解原意扣3分；轻微理解偏差扣1分；表达不准确扣0.5分",
                    "建议": "用材料原词适当修改，避免过度推断和主观臆测"
                },
                "层次分明": {
                    "说明": "是否按照重要性或逻辑顺序进行概括",
                    "扣分规则": "层次完全混乱扣3分；重点不突出扣2分；条理性欠佳扣1分",
                    "建议": "可按'总-分'或'分-总'结构组织内容"
                }
            },
            "结构逻辑": {
                "条理清晰": {
                    "说明": "是否分条列举、结构合理，有序递进",
                    "扣分规则": "结构严重混乱扣3分；条目重复扣1分；序号使用不规范扣0.5分",
                    "建议": "使用规范的序号标注，确保每条内容相对独立"
                },
                "分类合理": {
                    "说明": "是否按问题、原因、对策等类别有序归纳",
                    "扣分规则": "分类错误扣2分；类别交叉扣1分；分类不够细致扣0.5分",
                    "建议": "先梳理内容类别，再进行分类概括，类别要互斥"
                },
                "衔接紧密": {
                    "说明": "各要点之间是否衔接自然，逻辑连贯",
                    "扣分规则": "逻辑断裂扣2分；衔接生硬扣1分；过渡不够自然扣0.5分",
                    "建议": "适当使用关联词，注意前后呼应"
                }
            },
            "语言表达": {
                "简洁凝练": {
                    "说明": "是否用精炼的语言表达核心含义",
                    "扣分规则": "表达冗长累赘扣2分；重复赘述扣1分；个别词句不够简练扣0.5分",
                    "建议": "一句话表达一个要点，删除无用修饰语"
                },
                "表达准确": {
                    "说明": "用词是否准确，句式是否规范",
                    "扣分规则": "用词严重不当扣2分；语病扣1分；个别用词不够准确扣0.5分",
                    "建议": "选用准确的词语，避免模糊表达"
                },
                "语言规范": {
                    "说明": "是否符合书面语表达规范",
                    "扣分规则": "多处口语化表达扣2分；个别口语化扣1分；标点错误每处扣0.5分",
                    "建议": "使用书面语，注意标点符号的正确使用"
                }
            }
        }
    },
    "对策题": {
        "问法关键词": ["对策","启示","建议","措施","如何应对","怎么做","可行性方案","风险防控预案","数字化治理","流程再造","制度创新","试点推广","成本收益分析"],
        "评分维度": {
            "问题分析": {
                "问题识别": {
                    "说明": "是否准确识别材料中的核心问题",
                    "扣分规则": "遗漏主要问题扣3分；问题定位不准确扣2分；次要问题遗漏扣1分",
                    "建议": "先找出关键词句，明确问题的具体表现"
                },
                "成因分析": {
                    "说明": "是否深入分析问题产生的原因",
                    "扣分规则": "因果关系错误扣3分；原因分析浅显扣2分；分析不够深入扣1分",
                    "建议": "多角度分析问题根源，理清因果关系"
                },
                "影响评估": {
                    "说明": "是否分析问题的影响范围和程度",
                    "扣分规则": "影响分析严重偏差扣3分；评估片面扣2分；分析不够具体扣1分",
                    "建议": "考虑短期和长期影响，以及不同层面的影响"
                }
            },
            "对策设计": {
                "针对性": {
                    "说明": "对策是否与问题一一对应，切中要害",
                    "扣分规则": "对策完全偏离问题扣3分；针对性不强扣2分；对应不够精准扣1分",
                    "建议": "每个对策都要对应具体问题，避免空泛"
                },
                "可行性": {
                    "说明": "对策是否具体可行，易于操作",
                    "扣分规则": "对策完全不可行扣3分；操作性不强扣2分；实施细节不够扣1分",
                    "建议": "提出具体的实施步骤和方法"
                },
                "系统性": {
                    "说明": "对策是否形成完整的解决方案",
                    "扣分规则": "方案严重不完整扣3分；措施之间不协调扣2分；体系不够完善扣1分",
                    "建议": "考虑短期和长期措施的配合，注意各措施间的配套"
                }
            },
            "创新价值": {
                "创新性": {
                    "说明": "是否有创新性的解决思路和方法",
                    "扣分规则": "对策完全陈旧扣3分；创新不足扣2分；创新性不够突出扣1分",
                    "建议": "结合新技术、新理念提出解决方案"
                },
                "前瞻性": {
                    "说明": "是否考虑未来发展趋势和需求",
                    "扣分规则": "缺乏前瞻性考虑扣3分；预判不足扣2分；前瞻视角不够扣1分",
                    "建议": "关注发展趋势，预判可能出现的新问题"
                }
            },
            "实施保障": {
                "主体明确": {
                    "说明": "是否明确各项措施的实施主体",
                    "扣分规则": "主体完全不明确扣3分；职责混淆扣2分；主体不够具体扣1分",
                    "建议": "明确各项措施的责任主体和协作方"
                },
                "资源配置": {
                    "说明": "是否考虑必要的资源保障",
                    "扣分规则": "资源保障完全缺失扣3分；保障措施不足扣2分；配置不够合理扣1分",
                    "建议": "考虑人力、物力、财力等资源保障"
                }
            }
        }
    },
    "分析题": {
        "问法关键词": ["怎么看","怎么看待","理解","分析","评价","认识","辩证分析","治理困境","价值冲突","政策效应评估","利益相关者分析","制度伦理探讨","潜在影响"],
        "评分维度": {
            "分析深度": {
                "现象把握": {
                    "说明": "是否准确理解和描述分析对象",
                    "扣分规则": "理解完全错误扣4分；描述不准确扣2分；把握不够深入扣1分",
                    "建议": "准确把握核心现象，避免理解偏差"
                },
                "本质认识": {
                    "说明": "是否深入分析问题的本质特征",
                    "扣分规则": "本质特征把握错误扣3分；分析浅显扣2分；认识不够深刻扣1分",
                    "建议": "透过现象看本质，找出关键特征"
                },
                "理论支撑": {
                    "说明": "是否运用相关理论进行分析",
                    "扣分规则": "理论运用错误扣3分；理论支撑不足扣2分；理论联系不够扣1分",
                    "建议": "合理运用相关理论，加强分析说服力"
                }
            },
            "思维品质": {
                "辩证思维": {
                    "说明": "是否运用辩证思维分析问题",
                    "扣分规则": "思维完全片面扣3分；辩证分析不足扣2分；辩证性不够扣1分",
                    "建议": "注意分析问题的多个方面及其关系"
                },
                "逻辑严密": {
                    "说明": "分析过程是否逻辑严密",
                    "扣分规则": "逻辑严重混乱扣3分；论证不充分扣2分；逻辑不够严密扣1分",
                    "建议": "保持分析的逻辑性和连贯性"
                },
                "创新思维": {
                    "说明": "是否有创新性的分析视角",
                    "扣分规则": "视角陈旧扣2分；创新不足扣1.5分；创新性不够突出扣1分",
                    "建议": "尝试从新的角度分析问题"
                }
            },
            "论证质量": {
                "论据充实": {
                    "说明": "是否有充分的事实和数据支撑",
                    "扣分规则": "论据完全缺失扣3分；论据不恰当扣2分；论据不够充分扣1分",
                    "建议": "使用具体事例和数据支撑观点"
                },
                "分析全面": {
                    "说明": "是否从多个维度进行分析",
                    "扣分规则": "分析严重片面扣3分；维度遗漏扣2分；分析不够全面扣1分",
                    "建议": "从多个角度全面分析问题"
                }
            },
            "价值导向": {
                "价值立场": {
                    "说明": "是否体现正确的价值导向",
                    "扣分规则": "价值导向错误扣4分；立场不正确扣3分；价值体现不够扣2分",
                    "建议": "坚持正确的价值立场和导向"
                },
                "实践意义": {
                    "说明": "分析是否具有实践指导意义",
                    "扣分规则": "缺乏实践意义扣3分；指导性不强扣2分；应用价值不足扣1分",
                    "建议": "注重分析结论的实践应用价值"
                }
            }
        }
    },
    "应用文": {
        "问法关键词": ["写一份","写一封","写一则","写一篇","通知","倡议书","政务短评","政策解读稿","调研报告摘要","新闻发布会通稿","经验交流发言稿","突发事件应对方案"],
        "评分维度": {
            "格式规范": {
                "文种格式": {
                    "说明": "是否符合特定文种的格式要求",
                    "扣分规则": "格式完全错误扣4分；要素缺失每项扣2分；格式不够规范扣1分",
                    "建议": "严格按照文种格式规范写作"
                },
                "布局美观": {
                    "说明": "版面布局是否规范美观",
                    "扣分规则": "布局严重混乱扣3分；间距不当扣1分；美观度不足扣0.5分",
                    "建议": "注意文章整体布局和段落安排"
                },
                "规范要素": {
                    "说明": "必要的格式要素是否齐全",
                    "扣分规则": "关键要素缺失扣3分；要素不规范扣2分；要素不够完整扣1分",
                    "建议": "对照文种要求检查格式要素"
                }
            },
            "内容质量": {
                "主题突出": {
                    "说明": "主题是否明确，重点是否突出",
                    "扣分规则": "主题不明确扣4分；重点不突出扣2分；主旨不够清晰扣1分",
                    "建议": "开篇点明主题，全文突出重点"
                },
                "内容完整": {
                    "说明": "内容是否完整，要素是否齐全",
                    "扣分规则": "内容严重不完整扣3分；要素缺失扣2分；内容不够充实扣1分",
                    "建议": "确保必要内容完整，逻辑有序"
                },
                "针对性强": {
                    "说明": "是否针对特定对象和目的",
                    "扣分规则": "针对性完全不足扣3分；目的性不明扣2分；针对性不够强扣1分",
                    "建议": "明确写作对象和目的，有的放矢"
                }
            },
            "语言风格": {
                "语言规范": {
                    "说明": "语言是否规范得体",
                    "扣分规则": "语言严重不规范扣3分；用语不当扣2分；规范性不足扣1分",
                    "建议": "使用规范的公文用语"
                },
                "表达准确": {
                    "说明": "表达是否准确清晰",
                    "扣分规则": "表达严重不准确扣3分；含义模糊扣2分；准确性不足扣1分",
                    "建议": "用词准确，表达清晰"
                },
                "风格统一": {
                    "说明": "语言风格是否统一得体",
                    "扣分规则": "风格严重不统一扣3分；语气不当扣2分；统一性不足扣1分",
                    "建议": "保持语言风格的统一性"
                }
            },
            "实用价值": {
                "可操作性": {
                    "说明": "内容是否具有可操作性",
                    "扣分规则": "完全不可操作扣3分；执行难度大扣2分；操作性不足扣1分",
                    "建议": "注重内容的实际可操作性"
                },
                "实效性强": {
                    "说明": "是否具有现实指导意义",
                    "扣分规则": "实效性完全缺失扣3分；指导性差扣2分；实效性不足扣1分",
                    "建议": "确保内容具有实际指导价值"
                }
            }
        }
    },
    "大作文": {
        "问法关键词": ["写一篇文章","自拟题目","中国式现代化","高质量发展","共同富裕","数字政府","治理现代化","守正与创新","改革方法论","发展与安全","文化自信","生态文明"],
        "评分维度": {
            "立意水平": {
                "主题深刻": {
                    "说明": "立意是否深刻，主题是否鲜明",
                    "扣分规则": "立意完全偏离扣5分；主题不明确扣3分；深度不够扣2分",
                    "建议": "深入思考主题，提炼深刻立意"
                },
                "视角新颖": {
                    "说明": "是否有新颖的视角和思路",
                    "扣分规则": "视角陈旧老套扣3分；思路单一扣2分；新颖度不足扣1分",
                    "建议": "寻找独特的切入点和思考角度"
                },
                "价值导向": {
                    "说明": "是否体现正确的价值导向",
                    "扣分规则": "价值导向错误扣5分；立场不正确扣3分；价值引领不足扣2分",
                    "建议": "坚持正确的价值观和思想导向"
                }
            },
            "论证深度": {
                "论据充实": {
                    "说明": "论据是否充分，例证是否恰当",
                    "扣分规则": "论据完全缺失扣4分；例证不当扣2分；论据不够充分扣1分",
                    "建议": "选择有说服力的论据和例证"
                },
                "分析深入": {
                    "说明": "分析是否深入透彻",
                    "扣分规则": "分析流于表面扣4分；论证不充分扣2分；深度不够扣1分",
                    "建议": "深入分析问题，透彻论证观点"
                },
                "逻辑严密": {
                    "说明": "论证是否逻辑严密",
                    "扣分规则": "逻辑严重混乱扣4分；论证跳跃扣2分；严密性不足扣1分",
                    "建议": "注意论证的逻辑性和严密性"
                }
            },
            "结构布局": {
                "结构完整": {
                    "说明": "文章结构是否完整合理",
                    "扣分规则": "结构严重混乱扣4分；层次不清扣2分；完整性不足扣1分",
                    "建议": "确保文章结构完整，层次分明"
                },
                "布局合理": {
                    "说明": "各部分篇幅是否合理",
                    "扣分规则": "篇幅严重失衡扣3分；重点不突出扣2分；布局不够合理扣1分",
                    "建议": "合理安排各部分篇幅"
                },
                "过渡自然": {
                    "说明": "段落之间是否过渡自然",
                    "扣分规则": "过渡生硬突兀扣2分；衔接不当扣1分；过渡不够自然扣0.5分",
                    "建议": "注意段落间的自然过渡"
                }
            },
            "语言表达": {
                "语言生动": {
                    "说明": "语言是否生动形象",
                    "扣分规则": "语言严重呆板扣3分；表达单调扣2分；生动性不足扣1分",
                    "建议": "运用生动的语言表达"
                },
                "用词准确": {
                    "说明": "用词是否准确恰当",
                    "扣分规则": "用词严重不当扣3分；表达不准确扣2分；准确性不足扣1分",
                    "建议": "选用准确、恰当的词语"
                },
                "文风严谨": {
                    "说明": "文风是否严谨得体",
                    "扣分规则": "文风不严谨扣3分；语气不当扣2分；严谨性不足扣1分",
                    "建议": "保持严谨的文风和适当的语气"
                }
            },
            "创新价值": {
                "见解独到": {
                    "说明": "是否有独到的见解",
                    "扣分规则": "见解完全平庸扣4分；创新不足扣2分；独到性不够扣1分",
                    "建议": "提出独特的见解和思考"
                },
                "理论价值": {
                    "说明": "是否具有理论价值",
                    "扣分规则": "理论价值缺失扣4分；深度不够扣2分；价值不够突出扣1分",
                    "建议": "注重理论思考和价值提升"
                },
                "实践意义": {
                    "说明": "是否具有实践指导意义",
                    "扣分规则": "实践意义缺失扣3分；指导性弱扣2分；意义不够突出扣1分",
                    "建议": "关注理论与实践的结合"
                }
            }
        },
        "分档说明": {
            "一类文": "31–35分：立意高远，论证有力，语言优美，结构完备",
            "二类文": "21–30分：结构清晰，语言通顺，有一定深度",
            "三类文": "11–20分：表达基本通顺，主题明确但逻辑薄弱",
            "四类文": "6–10分：结构混乱，语言问题明显，论点不清",
            "五类文": "0–5分：严重跑题，内容空泛或逻辑混乱"
        }
    }
}

import re
from collections import defaultdict

def detect_question_type(question: str) -> str:
    """
    根据题干内容，自动识别题型。
    支持关键词匹配 + 匹配得分机制。
    """
    if not question.strip():
        return "未知题型"

    question = question.strip().replace("\n", "").replace(" ", "")

    scores = {}
    debug_hits = defaultdict(list)

    for q_type, meta in SCORING_RULES.items():
        keywords = meta.get("问法关键词", [])
        score = 0
        for kw in keywords:
            if kw in question:
                score += 1
                debug_hits[q_type].append(kw)
        scores[q_type] = score

    # 找到得分最高的题型
    best_match = max(scores.items(), key=lambda x: x[1])

    # Debug：打印匹配情况（可选，部署时可注释掉）
    print("🔍 匹配详情（关键词命中）：")
    for k, v in debug_hits.items():
        print(f"  - {k} 命中：{v} (得分：{scores[k]})")

    if best_match[1] == 0:
        return "未知题型"
    return best_match[0]


DEFAULT_CRITERIA = {
    "题型": "未知",
    "评分维度": {},
    "分档说明": {},
    "关键词": []
}


def get_scoring_criteria(text: str) -> Dict:
    """根据文本内容识别题型并返回对应的评分标准"""
    # 初始化最匹配的题型和匹配分数
    best_match = "未知题型"
    best_score = 0
    
    # 遍历所有题型
    for qtype, rules in SCORING_RULES.items():
        # 计算关键词匹配数
        keywords = rules["问法关键词"]
        score = sum(1 for keyword in keywords if keyword in text)
        
        # 更新最佳匹配
        if score > best_score:
            best_match = qtype
            best_score = score
    
    # 如果没有找到匹配的题型，返回默认的未知题型规则
    if best_match == "未知题型":
        return {
            "题型": "未知题型",
            "评分维度": {
                "基础要求": {
                    "内容完整": {
                        "说明": "内容是否完整，要素是否齐全",
                        "扣分规则": "内容不完整扣2分；要素缺失扣1分",
                        "建议": "确保回答所有问题要点"
                    },
                    "逻辑清晰": {
                        "说明": "思路是否清晰，结构是否合理",
                        "扣分规则": "逻辑混乱扣2分；结构不合理扣1分",
                        "建议": "保持思路清晰，结构完整"
                    }
                }
            }
        }
    
    # 返回匹配题型的规则
    return {
        "题型": best_match,
        **SCORING_RULES[best_match]
    } 