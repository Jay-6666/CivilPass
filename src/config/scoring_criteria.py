# scoring_criteria.py

from typing import Dict

SCORING_RULES = {
    "概括题": {
        "问法关键词": ["概括","总结","简要说明","归纳","提炼","提取","梳理","关键要素","核心信息","主要特征","差异比较","数据整合"],
        "评分维度": {
            "内容要点": {
                "信息覆盖": {
                    "说明": "是否覆盖材料中所有应概括的核心要素",
                    "扣分规则": "每遗漏1个关键点扣2分",
                    "建议": "全面提炼材料，勿遗漏关键词句"
                },
                "要点准确": {
                    "说明": "概括是否与原意一致，未歪曲材料含义",
                    "扣分规则": "错误概括或表达偏差 每处扣2分",
                    "建议": "核对原文，确保用词贴合材料"
                }
            },
            "结构逻辑": {
                "条理清晰": {
                    "说明": "是否分条列举、结构合理",
                    "扣分规则": "未分条列出，或条理混乱 扣1-2分",
                    "建议": "使用序号、先总后分，逻辑清楚"
                },
                "分类合理": {
                    "说明": "是否按问题、原因、对策等分类有序",
                    "扣分规则": "分类不清，内容交叉重叠 每类扣2分",
                    "建议": "注意同类合并，异类区分"
                }
            },
            "语言表达": {
                "简洁凝练": {
                    "说明": "是否去除冗余，使用短句表达",
                    "扣分规则": "句子冗长、重复扣1-2分",
                    "建议": "去掉重复修饰语，直奔主题"
                },
                "书写规范": {
                    "说明": "语言通顺、无语病、标点规范",
                    "扣分规则": "错别字/语病 ≥3处扣1分；涂改 ≥3处扣1分",
                    "建议": "通读全文，避免语法错误"
                }
            },
            "格式规范": {
                "序号标注": {
                    "说明": "是否使用1.2.3.或①②③等清晰编号",
                    "扣分规则": "缺编号或编号混乱 扣1分",
                    "建议": "建议统一用1.2.3.编号，清晰有序"
                },
                "重点前置": {
                    "说明": "是否将关键内容放在每条开头",
                    "扣分规则": "每条重点不在首句 扣1分",
                    "建议": "先点出核心，再补充说明"
                }
            }
        }
    },
    "对策题": {
        "问法关键词": ["对策","启示","建议","措施","如何应对","怎么做","可行性方案","风险防控预案","数字化治理","流程再造","制度创新","试点推广","成本收益分析"],
        "评分维度": {
            "问题识别": {
                "全面识别问题": {
                    "说明": "是否完整概括材料中出现的全部问题现象",
                    "扣分规则": "每漏一个核心问题，扣2分",
                    "建议": "先审题干是否要求'提出问题'，再结合材料细读提炼"
                },
                "问题表述准确": {
                    "说明": "描述是否客观、明确、无夸张主观色彩",
                    "扣分规则": "表述模糊、偏题，扣2分/处",
                    "建议": "用'存在...问题'、'当前...现象较突出'等中性描述"
                }
            },
            "对策设计": {
                "针对性强": {
                    "说明": "对策是否与问题一一对应，解决目标明确",
                    "扣分规则": "缺乏对应性或空泛泛讲，每对不准扣2分",
                    "建议": "一个问题配一个精准措施，必要时标明'针对...问题，可...'"
                },
                "操作可行": {
                    "说明": "措施是否具体、实际、具备执行性",
                    "扣分规则": "出现空洞大话、无法落地 扣2分/条",
                    "建议": "用'建立机制'、'强化监管'等务实措辞"
                },
                "主体明确": {
                    "说明": "是否明确由谁执行（政府/企业/个人等）",
                    "扣分规则": "无执行主体，或错配主体，每处扣1分",
                    "建议": "题干有身份限制时务必照顾清楚，如'假如你是...'，措施要贴合角色"
                }
            },
            "结构逻辑": {
                "条理清晰": {
                    "说明": "内容分层明确，结构清楚，层次分明",
                    "扣分规则": "结构混乱或无层次感 扣1-2分",
                    "建议": "建议使用'1.2.3.'编号或总分结构组织内容"
                },
                "分类合理": {
                    "说明": "是否根据问题属性/解决角度合理分组",
                    "扣分规则": "分类混乱，内容交叉，每类扣2分",
                    "建议": "可按主体（政府、企业、公众）或路径（法律、技术、宣传）分类"
                }
            },
            "语言表达": {
                "精准表达": {
                    "说明": "是否使用准确术语，句式规范",
                    "扣分规则": "错词、病句、表达混乱 每处扣1分",
                    "建议": "建议使用政策术语或行政语言，如'制度设计'、'职责落实'"
                },
                "书写规范": {
                    "说明": "是否存在错别字、标点错误、语病",
                    "扣分规则": "错别字/语病 ≥3处 扣1分；涂改≥3处再扣1分",
                    "建议": "通读全文，避免基本语病和书写失误"
                }
            },
            "格式规范": {
                "序号规范": {
                    "说明": "是否统一编号如'1.2.3.'或'（一）（二）'",
                    "扣分规则": "无编号、编号混乱 扣1分",
                    "建议": "建议统一编号风格，便于阅卷评分"
                },
                "重点前置": {
                    "说明": "每条开头是否突出对策关键词",
                    "扣分规则": "每条对策未先写重点 扣1分",
                    "建议": "先写'健全...机制'，再补充细节，便于快速阅卷"
                }
            }
        }
    },
    "分析题": {
        "问法关键词": ["怎么看","怎么看待","理解","分析","评价","认识","辩证分析","治理困境","价值冲突","政策效应评估","利益相关者分析","制度伦理探讨","潜在影响"],
        "评分维度": {
            "结构完整": {
                "三段要素齐全": {
                    "说明": "是否具备'解释 + 分析 + 总结'结构",
                    "扣分规则": "缺任意部分，每处扣3分",
                    "建议": "建议使用'我理解为...→原因是...→启示是...'结构"
                },
                "开头表态清晰": {
                    "说明": "首段是否有明确的中心观点或态度",
                    "扣分规则": "未明确表态或偏题，扣2分",
                    "建议": "第一句话开门见山表态，有利于结构展开"
                }
            },
            "内涵理解": {
                "准确解释词句": {
                    "说明": "是否准确还原关键词/句的本意",
                    "扣分规则": "解释片面、误解原意，扣2-3分",
                    "建议": "可先解释字面，再联系深层含义"
                },
                "理论支撑清晰": {
                    "说明": "是否结合政策、道理、常识进行理论分析",
                    "扣分规则": "没有支撑仅作感性描述，扣2分",
                    "建议": "用'这是因为...'、'体现的是...'等进行扩展"
                }
            },
            "外延分析": {
                "紧扣材料": {
                    "说明": "是否引用材料进行案例论证或对比说明",
                    "扣分规则": "未引用材料或引用失当，扣2分",
                    "建议": "使用'材料中提到的...说明了...'句式"
                },
                "联系现实": {
                    "说明": "是否结合当下社会现象、案例、热点话题分析",
                    "扣分规则": "泛泛而谈、脱离实际，扣2分",
                    "建议": "结合社会热点、改革举措、基层案例增强说服力"
                }
            },
            "论证逻辑": {
                "递进有序": {
                    "说明": "是否从解释—分析—总结层层推进",
                    "扣分规则": "论点跳跃、无过渡句，扣1-2分",
                    "建议": "合理使用'首先-其次-最后'等连接词"
                },
                "观点统一": {
                    "说明": "全文观点一致，不自相矛盾",
                    "扣分规则": "首尾观点不一致、模棱两可，扣2分",
                    "建议": "首段和末段回扣观点，避免立场摇摆"
                }
            },
            "语言表达": {
                "逻辑通顺": {
                    "说明": "句子是否通顺，表达是否流畅",
                    "扣分规则": "表达混乱、逻辑断裂，扣1-2分",
                    "建议": "使用连接词，减少主语不清或重复句式"
                },
                "用词规范": {
                    "说明": "语言是否正式、书面化、无病句",
                    "扣分规则": "错别字/病句 ≥3 扣1分",
                    "建议": "注意用词政治正确，如'实现共同富裕'"
                }
            },
            "格式规范": {
                "段落分明": {
                    "说明": "是否三段分明，段与段之间过渡自然",
                    "扣分规则": "无明显分段/一段到底，扣1分",
                    "建议": "建议解释一段、分析一段、总结一段"
                },
                "重点突出": {
                    "说明": "每段首句是否点明小论点或分析重心",
                    "扣分规则": "重点埋在段中或模糊不清，扣1分",
                    "建议": "每段开头写'当前...'，'本质在于...'引出主题"
                }
            }
        }
    },
    "应用文": {
        "问法关键词": ["写一份","写一封","写一则","写一篇","通知","倡议书","政务短评","政策解读稿","调研报告摘要","新闻发布会通稿","经验交流发言稿","突发事件应对方案"],
        "评分维度": {
            "结构格式": {
                "格式要素齐全": {
                    "说明": "是否具备标题、称谓、正文、落款等四要素（如题干要求）",
                    "扣分规则": "缺少任一要素，扣3分/项",
                    "建议": "格式统一规范，确保四要素完整"
                },
                "标题规范": {
                    "说明": "标题是否居中、自拟是否符合规范，如'关于...的...'",
                    "扣分规则": "位置错误、命名不当，扣2分",
                    "建议": "自拟标题建议采用'关于+内容+的+文种'结构"
                },
                "称谓得当": {
                    "说明": "是否根据身份和写作对象使用恰当称呼",
                    "扣分规则": "称谓不匹配身份、对象错误，扣1分",
                    "建议": "如为群众写：'广大市民朋友们：'；如为上级写：'各位领导：'"
                }
            },
            "内容契合": {
                "目的明确": {
                    "说明": "是否明确表达写作目的，如宣传、号召、介绍、总结等",
                    "扣分规则": "目的模糊或无主旨，扣2分",
                    "建议": "开头明确交代目的，例如'为贯彻...'，我单位决定...'"
                },
                "身份贴合": {
                    "说明": "是否从题干设定角色角度发言，避免角色错位",
                    "扣分规则": "角色错用第一/第三人称，或脱离身份视角，扣2分",
                    "建议": "假如你是'镇长'，就用'我镇将...'的表达方式"
                },
                "材料关联": {
                    "说明": "是否引用或回应材料中核心内容",
                    "扣分规则": "无材料支撑，内容脱节，扣2分",
                    "建议": "围绕材料关键信息展开，如'材料指出...，为此我建议...'"
                }
            },
            "结构逻辑": {
                "内容分段合理": {
                    "说明": "是否按问题-措施-效果等逻辑安排段落",
                    "扣分规则": "结构混乱、段落杂糅，扣2分",
                    "建议": "建议使用'现状+措施+希望'三段式结构"
                },
                "条理清晰": {
                    "说明": "是否使用序号/分条/过渡词清晰展现逻辑",
                    "扣分规则": "表达杂乱无序，缺乏层级感，扣1-2分",
                    "建议": "使用'一是...，二是...'、'首先...其次...最后...'等"
                },
                "内容完整": {
                    "说明": "是否从起因、任务、目标等维度全面展开",
                    "扣分规则": "内容单薄或缺项，扣2-3分",
                    "建议": "适当拓展背景、措施与结语呼吁"
                }
            },
            "语言表达": {
                "文种风格匹配": {
                    "说明": "是否体现出该文种的风格，如正式庄重、亲切有号召力等",
                    "扣分规则": "语言风格错位，扣2分",
                    "建议": "倡议书用'倡议大家...'，方案用'我们将采取...'"
                },
                "语言规范通顺": {
                    "说明": "语句是否通顺，无语病、错别字、冗词",
                    "扣分规则": "错别字/病句 ≥3 扣1分；句式重复、冗余 扣1分",
                    "建议": "避免白话、俚语，保持正式表达"
                }
            },
            "表达重点": {
                "关键词前置": {
                    "说明": "每条措施或观点开头是否点明重点内容",
                    "扣分规则": "每条重点埋藏在句中或末尾 扣1分",
                    "建议": "写作时采用'为此，我们应...'或'建议如下：1...'"
                },
                "分类明晰": {
                    "说明": "是否将不同类型内容分别列出，分类合理",
                    "扣分规则": "类别交叉、混乱、重复 每类扣1-2分",
                    "建议": "如按措施：政策类、组织类、宣传类"
                }
            }
        }
    },
    "大作文": {
        "问法关键词": ["写一篇文章","自拟题目","中国式现代化","高质量发展","共同富裕","数字政府","治理现代化","守正与创新","改革方法论","发展与安全","文化自信","生态文明"],
        "评分维度": {
            "立意深度": {
                "主题准确": {
                    "说明": "是否准确把握材料核心观点，立意不偏题",
                    "扣分规则": "立意偏离材料中心，扣5分以上",
                    "建议": "从材料中提炼关键词，如'责任'、'人民'、'改革'，再升华主题"
                },
                "思想深刻": {
                    "说明": "是否挖掘出本质问题、社会意义、深层逻辑",
                    "扣分规则": "泛泛而谈、表面解读，扣3-4分",
                    "建议": "使用'本质在于...'、'体现的是...'等进行深度升华"
                },
                "标题贴切": {
                    "说明": "标题是否紧扣中心，有吸引力又不脱离主题",
                    "扣分规则": "标题空泛或与内容脱节，扣2分",
                    "建议": "采用双层结构如'责任：现代社会的基石'"
                }
            },
            "论证严密": {
                "论点明确": {
                    "说明": "文章主张是否清晰、统一，段落中心突出",
                    "扣分规则": "论点模糊、观点反复/矛盾，扣2分",
                    "建议": "首段提出中心论点，段首点明小论点"
                },
                "论据丰富": {
                    "说明": "是否使用案例、政策、数据等支撑论点",
                    "扣分规则": "缺少事实支撑、空洞说理，扣3分",
                    "建议": "至少使用2个贴合论点的材料或现实例子"
                },
                "分析透彻": {
                    "说明": "是否对论据展开充分解释、阐释因果逻辑",
                    "扣分规则": "论据堆砌、缺乏分析，扣2分",
                    "建议": "通过'之所以...是因为...'结构展开推理"
                },
                "过渡自然": {
                    "说明": "是否使用连接句承上启下，段与段逻辑流畅",
                    "扣分规则": "段落跳跃、生硬转折，扣1-2分",
                    "建议": "使用'首先、其次、此外、最后'等过渡词"
                }
            },
            "结构完整": {
                "开头吸引": {
                    "说明": "是否首段引出主题，开门见山、设问或引用引入",
                    "扣分规则": "冗长铺垫、未引出主题，扣2分",
                    "建议": "可用材料/现实现象+设问+亮明观点结构"
                },
                "正文有序": {
                    "说明": "主体段层次清晰，每段1个分论点",
                    "扣分规则": "内容杂糅、段内跳跃，扣2分",
                    "建议": "每段围绕1个核心观点展开"
                },
                "结尾深化": {
                    "说明": "结尾是否总结全文、升华主题、表达情怀",
                    "扣分规则": "结尾草率、重复观点、无升华，扣2分",
                    "建议": "使用'综上所述...'、'新时代背景下，我们更应...'等句式"
                }
            },
            "语言表达": {
                "语言流畅": {
                    "说明": "句子是否通顺自然，表达清晰",
                    "扣分规则": "句式重复、语病频出，扣2分",
                    "建议": "使用复句和短句交替，避免口语化"
                },
                "文采表现": {
                    "说明": "是否有较好的遣词造句、修辞表达、句式变化",
                    "扣分规则": "语言单调平淡，扣2分",
                    "建议": "适度使用排比、比喻、对偶，提升表现力"
                },
                "用词规范": {
                    "说明": "书面用语是否准确，无错别字或政治错误",
                    "扣分规则": "错别字/病句≥3处扣1分，政治立场偏差一票否决",
                    "建议": "使用政策术语或官样语言增强权威性"
                }
            },
            "书写与篇幅": {
                "字数达标": {
                    "说明": "是否达到800字左右，切忌严重不足",
                    "扣分规则": "每少50字扣1分；少于600字扣5分以上",
                    "建议": "正文段落至少3段，每段150字以上"
                },
                "卷面整洁": {
                    "说明": "是否涂改少、书写清晰、段落分明",
                    "扣分规则": "字迹潦草、错字重写 ≥3 扣1分",
                    "建议": "字迹不求美观但要规整清楚"
                }
            }
        },
        "分档说明": {
            "一类文": "31–35分：立意高远，论证有力，语言优美，结构完备",
            "二类文": "21–30分：结构清晰，语言通顺，有一定深度",
            "三类文": "11–20分：表达基本通顺，主题明确但逻辑薄弱",
            "四类文": "6–10分：结构混乱，语言问题明显，论点不清",
            "五类文": "0–5分：严重跑题，内容空泛或逻辑混乱"
        }
    }
}

import re
from collections import defaultdict

def detect_question_type(question: str) -> str:
    """
    根据题干内容，自动识别题型。
    支持关键词匹配 + 匹配得分机制。
    """
    if not question.strip():
        return "未知题型"

    question = question.strip().replace("\n", "").replace(" ", "")

    scores = {}
    debug_hits = defaultdict(list)

    for q_type, meta in SCORING_RULES.items():
        keywords = meta.get("问法关键词", [])
        score = 0
        for kw in keywords:
            if kw in question:
                score += 1
                debug_hits[q_type].append(kw)
        scores[q_type] = score

    # 找到得分最高的题型
    best_match = max(scores.items(), key=lambda x: x[1])

    # Debug：打印匹配情况（可选，部署时可注释掉）
    print("🔍 匹配详情（关键词命中）：")
    for k, v in debug_hits.items():
        print(f"  - {k} 命中：{v} (得分：{scores[k]})")

    if best_match[1] == 0:
        return "未知题型"
    return best_match[0]


DEFAULT_CRITERIA = {
    "题型": "未知",
    "评分维度": {},
    "分档说明": {},
    "关键词": []
}


def get_scoring_criteria(question_text: str) -> Dict:
    qtype = detect_question_type(question_text)
    rules = SCORING_RULES.get(qtype)

    if not rules:
        return DEFAULT_CRITERIA

    return {
        "题型": qtype,
        "评分维度": rules.get("评分维度", {}),
        "分档说明": rules.get("分档说明", {}),
        "关键词": rules.get("问法关键词", [])
    } 